<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <style>
  @media print {
    *,
    *:before,
    *:after {
      background: transparent !important;
      color: #000 !important;
      box-shadow: none !important;
      text-shadow: none !important;
    }
  
    a,
    a:visited {
      text-decoration: underline;
    }
  
    a[href]:after {
      content: " (" attr(href) ")";
    }
  
    abbr[title]:after {
      content: " (" attr(title) ")";
    }
  
    a[href^="#"]:after,
    a[href^="javascript:"]:after {
      content: "";
    }
  
    pre,
    blockquote {
      border: 1px solid #999;
      page-break-inside: avoid;
    }
  
    thead {
      display: table-header-group;
    }
  
    tr,
    img {
      page-break-inside: avoid;
    }
  
    img {
      max-width: 100% !important;
    }
  
    p,
    h2,
    h3 {
      orphans: 3;
      widows: 3;
    }
  
    h2,
    h3 {
      page-break-after: avoid;
    }
  }
  
  html {
    font-size: 12px;
  }
  
  @media screen and (min-width: 32rem) and (max-width: 48rem) {
    html {
      font-size: 15px;
    }
  }
  
  @media screen and (min-width: 48rem) {
    html {
      font-size: 16px;
    }
  }
  
  body {
    line-height: 1.85;
  }
  
  p,
  .splendor-p {
    font-size: 1rem;
    margin-bottom: 1.3rem;
  }
  
  h1,
  .splendor-h1,
  h2,
  .splendor-h2,
  h3,
  .splendor-h3,
  h4,
  .splendor-h4 {
    margin: 1.414rem 0 .5rem;
    font-weight: inherit;
    line-height: 1.42;
  }
  
  h1,
  .splendor-h1 {
    margin-top: 0;
    font-size: 3.998rem;
  }
  
  h2,
  .splendor-h2 {
    font-size: 2.827rem;
  }
  
  h3,
  .splendor-h3 {
    font-size: 1.999rem;
  }
  
  h4,
  .splendor-h4 {
    font-size: 1.414rem;
  }
  
  h5,
  .splendor-h5 {
    font-size: 1.121rem;
  }
  
  h6,
  .splendor-h6 {
    font-size: .88rem;
  }
  
  small,
  .splendor-small {
    font-size: .707em;
  }
  
  /* https://github.com/mrmrs/fluidity */
  
  img,
  canvas,
  iframe,
  video,
  svg,
  select,
  textarea {
    max-width: 100%;
  }
  
  @import url(http://fonts.googleapis.com/css?family=Merriweather:300italic,300);
  
  html {
    font-size: 18px;
    max-width: 100%;
  }
  
  body {
    color: #444;
    font-family: 'Merriweather', Georgia, serif;
    margin: 0;
    max-width: 100%;
  }
  
  /* === A bit of a gross hack so we can have bleeding divs/blockquotes. */
  
  p,
  *:not(div):not(img):not(body):not(html):not(li):not(blockquote):not(p) {
    margin: 1rem auto 1rem;
    max-width: 36rem;
    padding: .25rem;
  }
  
  div {
    width: 100%;
  }
  
  div img {
    width: 100%;
  }
  
  blockquote p {
    font-size: 1.5rem;
    font-style: italic;
    margin: 1rem auto 1rem;
    max-width: 48rem;
  }
  
  li {
    margin-left: 2rem;
  }
  
  /* Counteract the specificity of the gross *:not() chain. */
  
  h1 {
    padding: 4rem 0 !important;
  }
  
  /*  === End gross hack */
  
  p {
    color: #555;
    height: auto;
    line-height: 1.45;
  }
  
  pre,
  code {
    font-family: Menlo, Monaco, "Courier New", monospace;
  }
  
  pre {
    background-color: #fafafa;
    font-size: .8rem;
    overflow-x: scroll;
    padding: 1.125em;
  }
  
  a,
  a:visited {
    color: #3498db;
  }
  
  a:hover,
  a:focus,
  a:active {
    color: #2980b9;
  }
  </style>
</head>
<body>
<h1>Sample Items Website</h1>
<h3>Table of Contents</h3>
<nav id="TOC">
<ul>
<li><a href="#application-overview">Application Overview</a><ul>
<li><a href="#license">License</a></li>
<li><a href="#installation">Installation</a></li>
</ul></li>
<li><a href="#project-architecture">Project Architecture</a></li>
<li><a href="#project-setup">Project Setup</a><ul>
<li><a href="#general-steps">General Steps</a></li>
<li><a href="#running">Running</a></li>
</ul></li>
<li><a href="#application-settings-and-configurations">Application Settings and Configurations</a></li>
<li><a href="#internal-dependencies">Internal Dependencies</a><ul>
<li><a href="#npm">NPM</a></li>
<li><a href="#bower">Bower</a></li>
<li><a href="#grunt">Grunt</a></li>
</ul></li>
<li><a href="#external-dependencies">External Dependencies</a><ul>
<li><a href="#docker">Docker</a></li>
<li><a href="#travisci">TravisCI</a></li>
<li><a href="#content-package">Content package</a></li>
</ul></li>
<li><a href="#deployment">Deployment</a><ul>
<li><a href="#ec2-instance-setup">EC2 Instance setup</a></li>
<li><a href="#code-deploy-setup">Code Deploy Setup</a></li>
<li><a href="#s3-setup">S3 setup</a></li>
<li><a href="#appspec.yml">appspec.yml</a></li>
</ul></li>
</ul>
</nav>
<h2 id="application-overview">Application Overview</h2>
<p>The Sample Items Website is a Microsoft ASP.NET Core MVC web application that displays sample test question items.</p>
<p>The content for the site is provided by a content package supplied by the Smarter Balanced Assessment Consortium. It consists of XML files that describe the test question items (the &quot;content package&quot;).</p>
<h3 id="license">License</h3>
<p>Mozilla Public License Version 2.0</p>
<h3 id="installation">Installation</h3>
<ul>
<li>Clone the project
<ul>
<li>Don't forget to initialize the project submodules (<a href="https://git-scm.com/book/en/v2/Git-Tools-Submodules#_cloning_submodules">instructions</a>)</li>
</ul></li>
<li>Install the latest version of Microsoft .NET Core for your operating system (<a href="https://www.microsoft.com/net/download/core#/current">link</a>)</li>
<li>Install the latest TypeScript compiler (<a href="https://www.typescriptlang.org/index.html#download-links">link</a>)</li>
<li>Download the latest sample item content package (TODO: Link?)
<ul>
<li>Place this in the location specified in src/Web/appsettings.json (<code>ContentRootDirectory</code>)</li>
</ul></li>
</ul>
<h2 id="project-architecture">Project Architecture</h2>
<p>The Sample Items Website project is composed of three layers: Web, Core, and Dal.</p>
<p><strong>Web</strong> is the startup project and contains controllers, views, style, and other web dependencies. See the <strong>Dependencies</strong> section for more information.</p>
<p><strong>Core</strong> provides business logic to Web via repositories. It also houses the business logic for the diagnosticAPI and model translations.</p>
<p><strong>Dal</strong> provides data to the Core layer. All data is supplied by a &quot;content package&quot; which is a set of XML files that represent test question items. This XML is parsed into the immutable <code>ItemDigest</code> and <code>ItemCard</code> models, which are used throughout the application.</p>
<p>Other XML data is used, such as <code>AccessibilityAccommodationConfigurations</code>, <code>ClaimConfigurations</code>, and <code>InteractionTypeConfigurations</code>. These configure information such as order and labels for accessibility and interaction types.</p>
<p><strong>Test</strong> is the test project for Sample Items Website. It contains unit tests and integration tests for each of the three aforementioned layers.</p>
<h2 id="project-setup">Project Setup</h2>
<h3 id="general-steps">General Steps</h3>
<ul>
<li>Clone the project
<ul>
<li>Don't forget to initialize the project submodules (<a href="https://git-scm.com/book/en/v2/Git-Tools-Submodules#_cloning_submodules">instructions</a>)</li>
</ul></li>
<li>Install the latest version of Microsoft .NET Core for your operating system (<a href="https://www.microsoft.com/net/download/core#/current">link</a>)</li>
<li>Install the latest TypeScript compiler (<a href="https://www.typescriptlang.org/index.html#download-links">link</a>)</li>
<li>Download the latest sample item content package
<ul>
<li>Place this in the location specified in src/Web/appsettings.json (<code>ContentRootDirectory</code>)</li>
</ul></li>
</ul>
<h3 id="running">Running</h3>
<h4 id="using-visual-studio-2015">Using Visual Studio 2015</h4>
<ul>
<li>Open the project in Visual Studio 2015</li>
<li>Click the run button</li>
</ul>
<h4 id="using-command-line">Using Command Line</h4>
<ul>
<li>Set environment variable <code>ASPNETCORE_ENVIRONMENT</code> to <code>Development</code>
<ul>
<li>in Windows: <code>setx ASPNETCORE_ENVIRONMENT &quot;Development&quot;</code>, then close and reopen the command prompt</li>
</ul></li>
<li><code>cd SampleItemsWebsite\SmarterBalanced.SampleItems</code></li>
<li><code>dotnet restore</code></li>
<li><code>cd src\SmarterBalanced.SampleItems.Web</code></li>
<li><code>dotnet run</code></li>
<li>Navigate to <code>http://localhost:&lt;port&gt;</code> in your browser to view the running site</li>
</ul>
<h2 id="application-settings-and-configurations">Application Settings and Configurations</h2>
<p>Within the <code>SmarterBalanced.SampleItems.Web</code> project, configurations are set in the file <code>appsettings.json</code>. This file contains all of the configurations and settings that are used throughout the application.</p>
<p>Within <code>appsettings.json</code>, the <code>SettingsConfig</code> object contains configurations necessary to start the application, as well as runtime configuration settings.</p>
<h5 id="following-is-a-description-of-important-configurations-within-this-object">Following is a description of important configurations within this object:</h5>
<p><code>ContentItemDirectory</code>: Location of the <strong>Items</strong> directory within the content package. Dependent on deployment environment setting (development, staging, production).</p>
<p><code>ContentRootDirectory</code>: Location of the content package. Dependent on deployment environment setting (development, staging, production).</p>
<p><code>AwsS3Bucket</code>: AWS S3 bucket that contains the content package. Required for the diagnostic status feature.</p>
<p><code>AwsRegion</code>: AWS region. Required for the diagnostic status feature.</p>
<p><code>ItemViewerServiceURL</code>: Base URL for itemviewerservice, which renders the test question items. URL is used to display an iframe of each item.</p>
<p><code>AwsClusterName</code>: Name of AWS cluster. Required for the diagnostic status feature.</p>
<p><code>StatusUrl</code>: Diagnostic status URL for local diagnostic status. Required for the diagnostic status feature.</p>
<p><code>AccommodationsXMLPath</code>: Location of the accessibility configurations XML document.</p>
<p><code>InteractionTypesXMLPath</code>: Location of the interaction types configuration XML document.</p>
<p><code>ClaimsXMLPath</code>: Location of the claims configuration XML document.</p>
<p>Additionally, the <code>RubricPlaceHolderText</code> object contains strings that are filtered out of item</p>
<h2 id="internal-dependencies">Internal Dependencies</h2>
<h3 id="npm">NPM</h3>
<p>NPM is required to install Grunt, Grunt packages, Less, and TypeScript. See <code>package.json</code> in the <strong>Web</strong> project for configurations.</p>
<h3 id="bower">Bower</h3>
<p>Bower is required to add Bootstrap, JQuery, and React. See <code>bower.json</code> in the <strong>Web</strong> project for configurations.</p>
<h3 id="grunt">Grunt</h3>
<p>Grunt is used to perform tasks with Visual Studio events as well as with build events. Grunt: - Compiles TypeScript files into JavaScript on save and build - Compiles Less CSS into CSS on save and build - Minifies CSS on build - Removes temp files</p>
<p>For Grunt configurations, see <code>Gruntfile.js</code> in the <strong>Web</strong> project.</p>
<h2 id="external-dependencies">External Dependencies</h2>
<h3 id="docker">Docker</h3>
<p>Docker is used to simplify and unify the build and runtime environment for the application.</p>
<p>See <code>Dockerfile</code> in the <strong>Web</strong> project for Docker configurations. The <strong>Web</strong> project also contains a <code>.dockerignore</code>.</p>
<h3 id="travisci">TravisCI</h3>
<p>TravisCI is used to verify the state of the application every time a developer pushes to a branch in the GitHub repository. It first installs project dependencies, pulls and builds the project, and then runs tests.</p>
<p>After the previous steps succeed, Travis builds a Docker image with the application and pushes it to AWS.</p>
<p>On the <strong>dev</strong>, <strong>stage</strong>, and <strong>master</strong> branches, Travis triggers a build process in AWS that combines the content package, hosted in an S3 bucket, with the application Docker image and performs a rolling update to the running versions of these branches.</p>
<p>See the <code>travis.yml</code> file in the root directory project for configurations.</p>
<h3 id="content-package">Content package</h3>
<p>The content for the site is provided by a content package supplied by the Smarter Balanced Assessment Consortium. It consists of XML files that describe the test question items (the &quot;content package&quot;).</p>
<p>Currently, content packages can be accessed at <a href="ftp://ftps.smarterbalanced.org/~sbacpublic/Public/PracticeAndTrainingTests/" class="uri">ftp://ftps.smarterbalanced.org/~sbacpublic/Public/PracticeAndTrainingTests/</a>.</p>
<h2 id="deployment">Deployment</h2>
<p>Code Deploy is triggered by Travis CI using the deploy section in the <code>.travis.yml</code> file. When the build on the dev, stage, or master branch is successful the branch specific deployment is run.<br />
The Travis build publishes the application using <code>dotnet publish</code>, and zips it into an archive, then pushes it to an Amazon S3 bucket, then triggers a Code Deploy deployment. The Code Deploy deployment deploys the application to a running EC2 instance that was set up using the instructions below.</p>
<h3 id="ec2-instance-setup">EC2 Instance setup</h3>
<p>The EC2 instance running the Sample Items Website needs an IAM role granting it read permissions to S3 and full access to Code Deploy. It requires <a href="https://www.nginx.com/resources/wiki/">Nginx</a>, [Supervisor], .NET Core, and the Amazon Code Deploy Agent to be installed on the instance. Nginx is used for reverse proxy.</p>
<p>Nginx and Supervisor can be installed with apt.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">sudo</span> apt-get update
<span class="fu">sudo</span> apt-get install nginx
<span class="fu">sudo</span> apt-get install supervisor</code></pre></div>
<p>.NET Core can be installed with apt after adding the the <code>dotnet-release</code> repo.</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="fu">sudo</span> sh -c <span class="st">&#39;echo &quot;deb [arch=amd64] https://apt-mo.trafficmanager.net/repos/dotnet-release/ trusty main&quot; &gt; /etc/apt/sources.list.d/dotnetdev.list&#39;</span>
<span class="fu">sudo</span> apt-key adv --keyserver apt-mo.trafficmanager.net --recv-keys 417A0893
<span class="fu">sudo</span> apt-get update
<span class="fu">sudo</span> apt-get install dotnet-dev-1.0.0-preview2-003131</code></pre></div>
<p>The install steps for .NET Core may change so please see <a href="https://www.microsoft.com/net/core#ubuntu">Microsoft's instructions</a> if the above does not work.<br />
Please see <a href="https://docs.aws.amazon.com/codedeploy/latest/userguide/how-to-run-agent-install.html">Amazon's instructions</a> for installing the code deploy agent.</p>
<p>All together in one script that can be run when the instance is created:</p>
<div class="sourceCode"><pre class="sourceCode sh"><code class="sourceCode bash"><span class="co">#!/bin/bash</span>
<span class="kw">set</span> <span class="ex">-ev</span>

<span class="fu">sudo</span> apt-get -y update
<span class="fu">sudo</span> apt-get -y install nginx
<span class="fu">sudo</span> apt-get -y install supervisor
<span class="fu">sudo</span> sh -c <span class="st">&#39;echo &quot;deb [arch=amd64] https://apt-mo.trafficmanager.net/repos/dotnet-release/ trusty main&quot; &gt; /etc/apt/sources.list.d/dotnetdev.list&#39;</span>
<span class="fu">sudo</span> apt-key adv --keyserver apt-mo.trafficmanager.net --recv-keys 417A0893
<span class="fu">sudo</span> apt-get -y update
<span class="fu">sudo</span> apt-get -y install dotnet-dev-1.0.0-preview2-003131
<span class="fu">sudo</span> apt-get -y install python-pip
<span class="fu">sudo</span> apt-get -y install ruby2.0
<span class="fu">sudo</span> apt-get -y install wget
<span class="fu">wget</span> https://aws-codedeploy-us-west-2.s3.amazonaws.com/latest/install
<span class="fu">chmod</span> +x ./install
<span class="fu">sudo</span> ./install auto</code></pre></div>
<h4 id="iam-role">IAM Role</h4>
<p>Create an IAM role with the AmazonS3ReadOnlyAccess and AWSCodeDeployFullAccess policies. Add the following custom policy:</p>
<div class="sourceCode"><pre class="sourceCode json"><code class="sourceCode json"><span class="fu">{</span>
    <span class="dt">&quot;Statement&quot;</span><span class="fu">:</span> <span class="ot">[</span>
        <span class="fu">{</span>
            <span class="dt">&quot;Action&quot;</span><span class="fu">:</span> <span class="ot">[</span>
                <span class="st">&quot;autoscaling:Describe*&quot;</span><span class="ot">,</span>
                <span class="st">&quot;cloudformation:Describe*&quot;</span><span class="ot">,</span>
                <span class="st">&quot;cloudformation:GetTemplate&quot;</span><span class="ot">,</span>
                <span class="st">&quot;s3:Get*&quot;</span>
            <span class="ot">]</span><span class="fu">,</span>
            <span class="dt">&quot;Resource&quot;</span><span class="fu">:</span> <span class="st">&quot;*&quot;</span><span class="fu">,</span>
            <span class="dt">&quot;Effect&quot;</span><span class="fu">:</span> <span class="st">&quot;Allow&quot;</span>
        <span class="fu">}</span>
    <span class="ot">]</span>
<span class="fu">}</span></code></pre></div>
<h4 id="what-to-install">What to install</h4>
<p>In order to deploy and run the Sample Items website the instance must have the following installed.</p>
<ul>
<li><a href="https://docs.aws.amazon.com/codedeploy/latest/userguide/how-to-run-agent-install.html">AWS Code Deploy Agent</a></li>
<li><a href="https://www.microsoft.com/net/core#ubuntu">.NET Core</a></li>
<li>Nginx</li>
<li>Supervisor</li>
</ul>
<h3 id="code-deploy-setup">Code Deploy Setup</h3>
<ul>
<li>In the AWS web console navigate to Code Deploy</li>
<li>Click &quot;Create New Application&quot;</li>
<li>Choose an application name. This must match the <code>application</code> used in the <code>.travis.yml</code> file under the <code>codedeploy</code> provider.</li>
<li>Choose a deployment group name. This must match the <code>deployment_group</code> used in the <code>.travis.yml</code> file under the <code>codedeploy</code> provider.</li>
<li>Under add instances add the EC2 instance you set up above.</li>
<li>Leave the default &quot;Deployment Configuration&quot; on &quot;CodeDeployDefault.OneAtATime&quot;</li>
<li>Set the Service Role to IAM role you created above.</li>
<li>Choose &quot;Create Application&quot;</li>
</ul>
<h3 id="s3-setup">S3 setup</h3>
<p>Create an S3 bucket to store the zip archive created by the Travis CI build. The name and region must match those specified in the <code>s3</code> provider in the <code>.travis.yml</code> file.</p>
<h3 id="appspec.yml">appspec.yml</h3>
<p>The appspec is the file that defines how the code deploy agent deploys the application. For the Sample Items Website it copies the configuration files for Nginx and Supervisor, and the application into the correct places, then starts Nginx and Supervisor to run the application.</p>
</body>
</html>